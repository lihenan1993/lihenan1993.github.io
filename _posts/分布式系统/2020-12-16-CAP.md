---
title: CPA
category: 分布式系统
typora-root-url: ../..
---

> 在一个分布式系统中，网络故障和节点宕机是常态，分区容错性（P）是一定需要的，因此设计系统时需要在可用性（A）和一致性（C）间进行权衡。

# 什么是CAP原则

CAP 原则指出，一个分布式存储系统提供的服务，不可能同时满足以下三点：

1. **一致性**（*Consistency*）：对于不同节点的请求，要么给出包含最新的修改响应、要么给出一个出错响应。
2. **可用性**（*Available*）：对于每个请求都会给出一个非错响应，但是不保证响应数据的时效性。
3. **分区容错性**（*Partition tolerance*）：当系统中节点间出现*网络分区*时，系统仍然能够正常响应请求。





### 一致性

分布式系统通常会包含多个数据节点（*Data Server*），将一个数据集（*Dataset*）分散到多个节点的方法常用的有三种：

1. **冗余（\*Replication\*）**：在多个节点上各存一份相同的全量数据集，每份称为**副本**（*Replica*）。
2. **分片（\*Partition***）：将数据集切成大小合适的几个分片，分别存到不同的节点上。
3. **冗余和分片**：将数据集切成多片，每片又冗余多份，将其存放到不同节点上。

正是数据的多机冗余和分片引出了分布式系统中的一致性问题。举个例子简单说明：

拿只有数据冗余的策略来说，假设有 *S0*、*S1*、*S2* 三个节点组成的一个数据系统，分别存放了某数据集 D 的三个副本 *D0*、*D1*、*D2* ，该数据集是个简单的**键值对**（*Key-value*）集合。初始，集合中 `"a" = 0`；某时刻 t，客户端 C0 向 *S0* 发送写请求 `set("a", 1)` ，并得到成功响应；紧跟 t 之后，另一个客户端 *C1* 向 *S1* 发送了一个读请求 `get("a")`，



![img](/assets/img/v2-df1342eaf90d36da322eb0d16c3be44e_720w.jpg)



如果系统如下设计：

1. *S0* 改变了 "a" 的值，并且将其同步到了 *S1*，*C1* 得到带有**全局最新**数据 `"a" = 1` 的响应
2. 系统检测到 *S1* 尚未同步最新数据，于是返回给 *C1* 一个**出错响应**，提示其进行重试

则该系统满足一致性。





### 可用性

这个性质比较好理解，即系统必须在**有限的时间**内给出**非错响应**。如果响应时间超过可以容忍时间的几个数量级，那么该服务基本不可用。系统反应很快，但是给出了一个出错响应，比如 bad file、data stale 等等，则服务仍然不可用。





### 分区容忍性

系统中的一部分和其他部分发生了网络隔离，互相不能够通信，进而不能及时完成数据同步，则可认为发生了网络分区。

如果发生了网络分区以后，系统仍然能够正常提供服务，则该系统具有**分区容错性**。





### 理解

在一个分布式系统中，网络故障和节点宕机是常态，因此网络分区是一定会出现的。在网络分区发生时，根据业务需求，系统需要在可用性和一致性之间二选一：

1. **优先保证可用性**。网络分区使得有些节点不可达，导致系统不能够及时同步数据。尽管被请求节点试图返回其可见范围内的最新数据，但仍不能保证该数据是全局最新的，即牺牲一致性保证可用性。
2. **优先保证一致性**。网络分区使得被请求节点不能够保证数据全局最新时，返回一个出错信息给用户；或者什么也不返回，直到客户端超时。

但该原则并不是说，系统在任何时候都必须抛弃 CAP 中的一个。比如系统网络状况良好时，并不需要在三者间进行取舍，此时不需要分区容错，可兼顾一致性和可用性。

深入理解这个原则，需要把握分布式系统设计时的两个关键因素：**网络环境**和**业务需求**。尤其要注意，原则是理想情况下的断言，而实践是实际场景下的取舍，CAP 原则只是点出了系统设计的三个重要权衡方向。