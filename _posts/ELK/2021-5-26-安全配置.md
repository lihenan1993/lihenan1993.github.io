---
title: 安全配置
category: ELK
typora-root-url: ../../
---

# 最低安全配置

对内置用户设置密码

1. 关闭ES 和 kibana

2. 开启密码验证

   ES_PATH_CONF/elasticsearch.yml

   ```
   xpack.security.enabled: true
   ```

3. 启动ES

4. 运行密码生成程序，注意集群的话仅运行一次

   ```
   ./bin/elasticsearch-setup-passwords auto
   将输出的密码保存起来
   ```

   > 运行之后不能再运行生成密码



Kibana 通过内置用户连接ES

1. 编辑配置文件

   ```
   kibana.yml
   
   elasticsearch.username: "kibana_system"
   ```

2. 通过密码库设置密码

   ```
   ./bin/kibana-keystore create
   ./bin/kibana-keystore add elasticsearch.password
   下方出现提示后，输入密码
   ```

3. 重启kibana



# 基本安全配置

不开启基本安全配置， 集群无法启动

基本安全配置是集群中添加TLS认证，未认证的节点不能加入集群

## 准备

需要先开启最低安全配置

## 步骤

1. 创建CA

   ```
   ./bin/elasticsearch-certutil ca
   
   提示 ，文件名默认为 elastic-stack-ca.p12
   输入密码
   ```

2. 为节点生成证书和私钥

   ```
   ./bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12
   
   输入密码
   设置证书密码
   ```

   输出文件是  elastic-certificates.p12 ， 其中包含节点证书，节点key，CA证书

3. 复制 elastic-certificates.p12 和 elastic-stack-ca.p12 文件到，每个节点的config配置目录



## Es配置

1. 修改， 每台节点都需要配置

   ```
   xpack.security.transport.ssl.enabled: true
   xpack.security.transport.ssl.verification_mode: certificate 
   xpack.security.transport.ssl.client_authentication: required
   xpack.security.transport.ssl.keystore.path: elastic-certificates.p12
   xpack.security.transport.ssl.truststore.path: elastic-certificates.p12
   ```

   

2. 存储密码， 每台节点都需要配置

   ```
   ./bin/elasticsearch-keystore add xpack.security.transport.ssl.keystore.secure_password
   ./bin/elasticsearch-keystore add xpack.security.transport.ssl.truststore.secure_password
   ```

   

## 说明

两个安全配置可以同步进行

先配置 基本安全配置并设置xpack.security.enabled: true  ，然后自动生成密码



 ## 后续节点加入

1. 配置文件复制 ，改节点名等集群配置

2. 复制elastic-certificates.p12到节点

3. ```
   ./bin/elasticsearch-keystore add xpack.security.transport.ssl.keystore.secure_password
   ./bin/elasticsearch-keystore add xpack.security.transport.ssl.truststore.secure_password
   ```



# Kibana

添加密码

1. 关闭kibana

2. ```
   ./bin/kibana-keystore create
   ./bin/kibana-keystore add elasticsearch.username
   输入用户名
   kibana_system
   ./bin/kibana-keystore add elasticsearch.password
   输入密码
   ```

3. 启动 用kibana_system用户登陆



## logstash

1. 关闭

2. kibana 添加一个角色 ，有logstash-system权限，索引*

3. 用新角色，创建一个用户

4. ```
   这步pass吧 ，有点问题
   
   set +o history
   export LOGSTASH_KEYSTORE_PASS=输入一个密码
   set -o history
   ./bin/logstash-keystore create
   ./bin/logstash-keystore add ES_USER
   ./bin/logstash-keystore add ES_PWD
   ```

5. 输出中配置用户名和密码