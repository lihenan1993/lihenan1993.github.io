---
title: 部署
category: ELK
typora-root-url: ../../
---

 

## 配置

### ES 

> ES-hot-1
>
> 内网:10.138.0.150
> 外网:34.82.152.90
> 额外port:

> ES-hot-2
>
> 内网:10.138.0.151
> 外网:35.197.62.104
> 额外port:

> ES-hot-3
>
> 内网:10.138.0.152
> 外网:34.82.255.153
> 额外port:


## kibana-logstash

> 内网:10.138.0.160
> 外网:35.247.86.108
> 额外port:

## 部署

## 挂载硬盘

1. 查看磁盘

   ```
   parted
   print list
   ```

   看到未挂载的硬盘

   Error: /dev/sdb: unrecognised disk label
   Model: Google PersistentDisk (scsi)                                       
   Disk **/dev/sdb**: 107GB
   Sector size (logical/physical): 512B/4096B
   Partition Table: unknown
   Disk Flags: 

   也可以用

   ```
   lsblk
   ```

   

   ```sh
   NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
   sda      8:0    0   20G  0 disk 
   ├─sda1   8:1    0  200M  0 part /boot/efi
   └─sda2   8:2    0 19.8G  0 part /
   sdb      8:16   0  100G  0 disk 
   ```

   

2. 将磁盘sdb格式化为ext4格式

   > 关于ext4格式
   >
   > https://zh.wikipedia.org/wiki/Ext4

   ```sh
   mkfs.xfs -f /dev/sdb
   ```

   

   ```sh
   Discarding blocks...Done.
   meta-data=/dev/sdb               isize=512    agcount=4, agsize=6553600 blks
            =                       sectsz=4096  attr=2, projid32bit=1
            =                       crc=1        finobt=0, sparse=0
   data     =                       bsize=4096   blocks=26214400, imaxpct=25
            =                       sunit=0      swidth=0 blks
   naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
   log      =internal log           bsize=4096   blocks=12800, version=2
            =                       sectsz=4096  sunit=1 blks, lazy-count=1
   realtime =none                   extsz=4096   blocks=0, rtextents=0
   ```

3. 将磁盘挂载为分区

   ```
   mkdir /data
   mount /dev/sdb /data
   chmod 777 /data
   ```

4. 设置开机自动挂载sdb分区

   ```sh
   vim /etc/fstab
   在文件fstab的末位加入下面一行代码：
   /dev/sdb /data xfs defaults 0 0
   ```

   

### 工具准备

```sh
sudo su
yum install -y wget lrzsz
```





### ES集群部署

1. 下载

   ```sh
   # 注意，不要用root用户，ES不允许root用户启动程序
   
   wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.12.1-linux-x86_64.tar.gz
   tar -xzf elasticsearch-7.12.1-linux-x86_64.tar.gz
   cd elasticsearch-7.12.1/
   ```

2. 修改配置

   > https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html#initial_master_nodes

   ```sh
   vi config/elasticsearch.yml
   
   cluster.name: zesen-ES
   node.name: master-hot-1
   node.roles: [ master, data_hot ]
   network.host: 0.0.0.0
   discovery.seed_hosts: ["10.138.0.150", "10.138.0.151","10.138.0.152"]
   cluster.initial_master_nodes: ["master-hot-1", "master-hot-2","master-hot-3"]
   ```

   其他机器配置相同，修改node.name ,node.attr.rack

   

   官网有特殊说明，7.12版本，默认情况，jvm heap 大小自动会设置，不建议修改。

   因此现在不按网上的教程，调整堆内存。

   > By default, Elasticsearch automatically sets the JVM heap size based on a node’s [roles](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#node-roles) and total memory. We recommend the default sizing for most production environments.

4. 修改系统配置

   1. 禁用swap

      ```
      sudo su
      swapoff -a
      
      vi /etc/fstab
      注释掉所有swap行
      ```

   2. 修改文件描述符 和 线程数

      ```
      ulimit -n 65535
      ulimit -u 4096
      
      vi /etc/security/limits.conf
      * soft nofile 65535
      * hard nofile 65535
      * soft nproc 4096
      * hard nproc 4096
      
      退出登陆后生效
      exit
      exit
      ```

   3. 增加虚拟内存计数 ，修改TCP重传次数

      ```sh
      sudo su
      sysctl -w vm.max_map_count=262144
      sysctl -w net.ipv4.tcp_retries2=5
      
      vi /etc/sysctl.conf
      net.ipv4.tcp_retries2=5
      ```

      

5. 复制到其他两台机器

   ```
   chmod 600 ./adminserver
   scp -i ./adminserver -r ./metricbeat.tar.gz zesen@10.138.0.152:/data/
   ```

   修改节点名 和 系统配置

6. 启动

   ```
   echo "./bin/elasticsearch -d -p pid" > start.sh
   
   sh start.sh
   ```

7. 脚本

   ```
   启动状态检查
   echo "curl -XGET 'http://localhost:9200/_cluster/health?pretty'" > test.sh
   ```

   

## logstash部署

1. 下载

   ```
   cd /data
   wget https://artifacts.elastic.co/downloads/logstash/logstash-7.12.1-linux-x86_64.tar.gz
   tar -xzf logstash-7.12.1-linux-x86_64.tar.gz
   ```

2. 修改内存

   ```
   vi config/jvm.options
   # Xms represents the initial size of total heap space
   # Xmx represents the maximum size of total heap space
   
   -Xms4g
   -Xmx4g
   ```

   

3. 测试

   ```
   bin/logstash -e 'input { stdin { } } output { stdout {} }'
   
   等待几分钟
   输入hello world
   会返回
   {
       "@timestamp" => 2021-05-13T08:35:19.876Z,
         "@version" => "1",
          "message" => "hello world",
             "host" => "logstash"
   }
   
   ctrl + d 退出程序
   ```

3. ```
   vi config/config.d/file-beat-es.conf
   
   ```

4. ```
   echo "nohup bin/logstash -f config/config.d/ --config.reload.automatic >logs/run.log &" > start.sh
   ```

5. 



## Filebeat

1. 下载

   ```sh
   curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.12.1-linux-x86_64.tar.gz
   tar -xzf filebeat-7.12.1-linux-x86_64.tar.gz
   ```

2. 配置文件需要加权限

   ```
   chmod 600 mobile-filebeat.yaml
   ```

   

3. 启动

   ```
   echo "nohup ./filebeat -c config/mobile-filebeat-3.yaml >logs/run3.log &" > start3.sh
   ./filebeat -c mobile-filebeat.yaml -e
   ```

   

4. 清空同步进度

   ```
   rm -rf data/registry
   ```

   

## kibana

1. 下载

   ```sh
   curl -O https://artifacts.elastic.co/downloads/kibana/kibana-7.12.1-linux-x86_64.tar.gz
   tar -xzf kibana-7.12.1-linux-x86_64.tar.gz
   cd kibana-7.12.1-linux-x86_64/
   ```

2. 配置

3. 启动

   ```
   echo "nohup ./bin/kibana > run.log &" > start.sh
   ```

   



## ES集群滚动重启

```
PUT _cluster/settings
{
  "persistent": {
    "cluster.routing.allocation.enable": "primaries"
  }
}

关闭单个节点
kill $(cat pid)

修改配置
启动

重复上面操作

等待yello

PUT _cluster/settings
{
  "persistent": {
    "cluster.routing.allocation.enable": "all"
  }
}
```

