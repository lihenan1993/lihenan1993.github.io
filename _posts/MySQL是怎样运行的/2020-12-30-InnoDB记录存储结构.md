---
title: InnoDB记录存储结构
category: MySQL是怎样运行的
typora-root-url: ../../
---

 # InnoDB记录存储结构

InnoDB 是MySQL默认的存储引擎

## InnoDB页

InnoDB是将数据存储到磁盘上的存储引擎，所以读和改都要涉及到 磁盘和内存的数据交换。

InnoDB将数据划分为若干个页，以页作为磁盘和内存之间的交互的基本单位。

默认一页大小 16KB ，指定数据目录的时候可以改。

也就是说，一次最少从磁盘读取16KB到内存，一次最少把16KB内存刷入磁盘



## 行格式

记录在页上的存储格式

InoDB目前有四种行格式：compact（简洁的）、redundant（冗余的）、dynamic（动态的）、compress（压缩的）

![image_1c9g4t114n0j1gkro2r1h8h1d1t16.png-42.4kB](/assets/img/169710e8fafc21aa)

1. 变长字段长度列表

compact：把所有变长字段的真实数据占用的字节长度都存放在记录的开头部位，从而形成一个变长字段长度列表，各变长字段数据占用的字节数按照列的顺序逆序存放

- MxW

  最多占用字节数

- L

  实际占用字节数

> 如果`M×W > 255`，则分为两种情况：
>
> - 如果`L <= 127`，则用1个字节来表示真正字符串占用的字节数。
> - 如果`L > 127`，则用2个字节来表示真正字符串占用的字节数。

2. NULL值列表

   1. 统一记录一条记录中值为NULL的列，存储到NULL值列表中

   2. 允许空值的列，逆序做成bitmap，1代表NULL，0代表不为NULL

   3. 必须为整数个字节位表示，不够的前面补零

      ![image-20210101181523056](/assets/img/image-20210101181523056.png)

3. 记录头

   用于描述记录的记录头信息，它是由固定的5个字节组成。也就是40个二进制位，不同的位代表不同的意思。

   ![image-20210101181624712](/assets/img/image-20210101181624712.png)

4. 记录的真实信息，有三个隐藏列

   ![image-20200129152851500](/assets/img/a4fc572790294e918a85c4f7aa5758fa.jpg)

## 数据页结构快览

数据页代表的16KB大小的存储空间，可以划分为多个部分

![image-20200129175558772](/assets/img/16ff0ca0b3ae67b7)

![image-20200129175624645](/assets/img/16ff0ca0b41f6bff)



### 记录部分的存储结构

有两条虚拟记录，是MySQL插入的 Infimum 和 Supremum 记录。

通过next_record形成的一个单向链表，按主键值从小到大的顺序链接起来的

![image-20200129180219930](/assets/img/16ff0ca0b6b2ea97)

记录被删除就修改next_record的指针 和 deleted_flag的值



###　页目录

将记录分成Ｎ组，每组的头一条记录的n_owned属性记录组员有多少字节，然后头记录的偏移量以2字节的方式记录到Page Director（页目录）的槽中。为了加快检索。

> InnoDB把页中的记录划分为若干个组，每个组的最后一个记录（组内最大值）的地址偏移量作为一个槽，存放在Page Directory中

![image-20210101200850871](/assets/img/image-20210101200850871.png)



#### 在一个页中查找主键元素的步骤

1. 通过二分法确定该记录所在分组对应的槽，然后找到该槽所在分组中主键值最小的那条记录
2. 通过记录的next_record属性遍历该槽所在的组中的各个记录



### 文件头部 File Header

上一页，下一页页号，页类型相关信息



### 页面头部 Page Header

记录页内的信息

页目录中槽数量、未使用空间、已使用空间、已删除记录字节数、插入方向、最后插入位置、当前页在B+树中所处的层级、当前页属于哪个索引



### 文件尾部 File Trailer

校验和，防止写磁盘时候发生错误



