---
title: 数据结构与对象
category: Redis设计与实现
typora-root-url: ..
---

# String - SDS

redis里面，C字符串只会作为字符串字面量用在一些无须对字符串值进行修改的地方，比如打印日志



## 什么是SDS

redis中String键和值用的是 简单动态字符串(simple dynamic string, SDS)

![image-20201218214106744](/assets/img/image-20201218214106744.png)

```c
struct sdshdr {
    // 记录buf数组中已使用字节的数量
    // 等于SDS所保存字符串的长度
    int len;
    // 未使用字节的数量
    int free;
    // 字节数组，用于保存字符串
    char buf[];
}
```



## C 字符串和 SDS 之间的区别

| C 字符串                                             | SDS                                                  |
| :--------------------------------------------------- | :--------------------------------------------------- |
| 获取字符串长度的复杂度为 O(N) 。                     | 获取字符串长度的复杂度为 O(1) 。                     |
| API 是不安全的，可能会造成缓冲区溢出。               | API 是安全的，不会造成缓冲区溢出。                   |
| 修改字符串长度 `N` 次必然需要执行 `N` 次内存重分配。 | 修改字符串长度 `N` 次最多需要执行 `N` 次内存重分配。 |
| 只能保存文本数据。                                   | 可以保存文本或者二进制数据。                         |
| 可以使用所有 `<string.h>` 库中的函数。               | 可以使用一部分 `<string.h>` 库中的函数。             |



## 优点

1. 扩容时候，不会造成缓冲区溢出
2. 减少修改字符串时候内存重分配次数
   1. 空间预分配， 修改后len小于1M，则预分配的free等于len ，最多为1M
   2. 惰性空间释放，缩短时候修改len和free，不是立即释放
3. 二进制安全，因为用的len ,而不是C中'\0'作为结束标志
4. 兼容部分C的函数，因为保留了结尾的'\0' 

