---
title: 第三部分-多机数据库的实现
category: Redis
typora-root-url: ../../
---

 # 复制-主从数据库

可以通过 SLAVEOF 让一个服务器去复制另一个服务器。

被复制的服务器为 主服务器（master），复制它的为 从服务器（slave）



### 复制的方法

SLAVEOF 127.0.0.1 6379

这样主从数据库状态将保持一直

往主数据库写入，从数据库能读取



### 好处

1. 读扩展

   master用于写，多个slave分摊读的压力

2. 数据冗余

   数据的热备份，是持久化之外的一种数据冗余方式

3. 高可用

   master挂掉，可以提升slave为master，进而实现故障转移



### 注意事项

1. 主服务器如果没开启持久化，就要禁用自动重启。否则重启后主数据库被清空，从数据库复制住数据库，数据也会被清空。
2. 断线后，从服务器会主动同步主服务器，完整同步或者部分同步
3. 主从服务器可以都不开身份验证，或者都开启且密码相同。否则连接失败
4. 从库默认是只读的，可配置成读写



### 同步过程

1. 从服务器发送SYNC
2. 主服务器BGSAVE，开启**复制缓冲区**，将写记录存入
3. 发送RDB文件
4. 从服务器根据RDB同步数据库状态
5. 主服务器发送缓冲区的写命令，从数据库同步





2.8版本以后用 PSYNC 代替 SYNC

使得从服务器断线后，可以从 **复制积压缓冲区** 部分重同步

> 复制缓冲区(replication_buffer )：主节点开始和一个从节点进行全量同步时，会为从节点创建一个输出缓冲区，这个缓冲区就是复制缓冲区。当主节点向从节点发送 RDB 文件时，如果又接收到了写命令操作，就会把它们暂存在复制缓冲区中。等 RDB 文件传输完成，并且在从节点加载完成后，主节点再把复制缓冲区中的写命令发给从节点，进行同步。对主从同步的影响：如果主库传输 RDB 文件以及从库加载 RDB 文件耗时长，同时主库接收的写命令操作较多，就会导致复制缓冲区被写满而溢出。一旦溢出，主库就会关闭和从库的网络连接，重新开始全量同步。所以，我们可以通过调整 **client-output-buffer-limit** slave 这个配置项，来增加复制缓冲区的大小，以免复制缓冲区溢出。



> 复制积压缓冲区 (replication backlog buffer)：**固定长度的、先进先出(FIFO)队列**，主节点和从节点进行常规同步时，会把写命令也暂存在复制积压缓冲区中。如果从节点和主节点间发生了网络断连，等从节点再次连接后，可以从复制积压缓冲区中同步尚未复制的命令操作。对主从同步的影响：如果从节点和主节点间的网络断连时间过长，复制积压缓冲区可能被新写入的命令覆盖。此时，从节点就没有办法和主节点进行增量复制了，而是只能进行全量复制。针对这个问题，应对的方法是调大复制积压缓冲区的大小 **repl-backlog-size**

### 命令传播

主服务器将收到的写命令，发送给从服务器

### 部分重同步实现方式

1. 从服务器向主服务器发送 runID (服务器运行ID ，40个随机16进制字符)
2. 核对成功后，发送 offset 
3. 从复制积压缓冲区恢复

复制积压缓冲区默认1MB，需要根据 2 * 断线恢复所需时间 * 主服务器每秒产生数据MB 设置



### 主从复制失败可能存在的问题

1. 防火墙对应的TCP端口没开
2. 认证失败
3. 主服务器忙
4. 复制缓冲区过小
5. 复制积压缓冲区过小（频繁全同步）



## 心跳检测

在命令传播阶段，从服务器默认每一秒一次的频率，向主服务器发送命令

1. 检测网络连接

2. 辅助实现min-slaves

   > 主服务器设置
   >
   > min-slaves-to-write 1
   >
   > min-slaves-max-lag 10
   >
   > 如果从服务器少于1个，或者断线10秒，**主服务器会拒绝写操作**

3. 检测命令丢失，之前同步的数据丢失，会从复制积压缓冲区再同步



# Sentinel 哨兵

Redis高可用性的解决方案

由一个或多个Sentinel实例组成的Sentinel系统可以监视任意多个主服务器，以及这些主服务器下的所有从服务器

如果主服务器下线，自动将从服务器提升为主服务器

主服务器上线后，自动设置为从服务器



> - Sentinel 只是一个运行在特殊模式下的 Redis 服务器， 它使用了和普通模式不同的命令表， 所以 Sentinel 模式能够使用的命令和普通 Redis 服务器能够使用的命令不同。
> - Sentinel 会读入用户指定的配置文件， 为每个要被监视的主服务器创建相应的实例结构， 并创建连向主服务器的命令连接和订阅连接， 其中命令连接用于向主服务器发送命令请求， 而订阅连接则用于接收指定频道的消息。
> - Sentinel 通过向主服务器发送 INFO 命令来获得主服务器属下所有从服务器的地址信息， 并为这些从服务器创建相应的实例结构， 以及连向这些从服务器的命令连接和订阅连接。
> - 在一般情况下， Sentinel 以每十秒一次的频率向被监视的主服务器和从服务器发送 INFO 命令， 当主服务器处于下线状态， 或者 Sentinel 正在对主服务器进行故障转移操作时， Sentinel 向从服务器发送 INFO 命令的频率会改为每秒一次。
> - 对于监视同一个主服务器和从服务器的多个 Sentinel 来说， 它们会以每两秒一次的频率， 通过向被监视服务器的 `__sentinel__:hello` 频道发送消息来向其他 Sentinel 宣告自己的存在。
> - 每个 Sentinel 也会从 `__sentinel__:hello` 频道中接收其他 Sentinel 发来的信息， 并根据这些信息为其他 Sentinel 创建相应的实例结构， 以及命令连接。
> - Sentinel 只会与主服务器和从服务器创建命令连接和订阅连接， Sentinel 与 Sentinel 之间则只创建命令连接。
> - Sentinel 以每秒一次的频率向实例（包括主服务器、从服务器、其他 Sentinel）发送 PING 命令， 并根据实例对 PING 命令的回复来判断实例是否在线： 当一个实例在指定的时长中连续向 Sentinel 发送无效回复时， Sentinel 会将这个实例判断为主观下线。
> - 当 Sentinel 将一个主服务器判断为主观下线时， 它会向同样监视这个主服务器的其他 Sentinel 进行询问， 看它们是否同意这个主服务器已经进入主观下线状态。
> - 当 Sentinel 收集到足够多的主观下线投票之后， 它会将主服务器判断为客观下线， 并发起一次针对主服务器的故障转移操作。



## 集群

Redis Sentinal着眼于高可用，在master宕机时会自动将slave提升为master，继续提供服务。

Redis Cluster着眼于扩展性，在单个redis内存不足时，使用Cluster进行分片存储。

## 连接方式

```
CLUSTER MEET ip port
```

配置文件

cluster-enabled: yes

![digraph {}](/assets/img/graphviz-76550f578052d5f52e35414facb5ac680d38c7f5.png)



## 槽指派

1. 集群 16384 个槽

- 协议文件小
- 太多的话，healthcheck占资源
- 1000个节点足够



2. 集群启动需要指派节点处理那些槽的key

```
CLUSTER ADDSLOTS 0 1 2 3 ... 5005
```

3. 节点会将自己的槽指派与其他节点同步



## 集群中执行命令

1. key在当前槽直接执行
2. 否则返回MOVED错误，转发给正确的槽

> 集群只能使用0号数据库



## 重新分片

```
重新分片时，集群不需要下线，并且源节点和目标节点都可以继续处理命令请求。

在hash slot迁移过程中（一部分key-value在node3中，另一部分key-value在node4中）

如果客户端向node3发送一个与数据库key有关的命令：

    1）node3会先在自己的数据库里面查找请求的key，

        如果找到，直接执行客户端发送的命令。

    2）如果没找到，node3给客户端返回一个ASK错误，指引客户端转向node4，

         并且客户端需要再次发送想要执行的key相关的命令。    

    3）客户端转向node4，首先发送ASKING命令，然后再次发送想要执行的key相关的命令。

         如果直接发送想要执行的key相关的命令，node4此时并不处理，

         因为key所在的槽还未迁移完，槽还属于node3，会返回错误给客户端。

         但如果先发送ASKING命令，node4在执行key相关的命令时，

         不仅会检查key所属槽是否属于自己，

         还会检查migration_slots_to数组（正在迁往自己的槽）

         判断key相关的槽是否正在迁往自己，如果是的话，则执行key相关的命令。
```

ASK解决方案?



## 复制与故障转移

集群中的节点也可以设置主从

```
CLUSTER REPLICATE node_id
```

从节点会复制主节点数据

### 故障检测

每个节点会定期向集群中的其他节点发送PING信息（健康检测），以此来检测对方是否在线

主节点下线，会自动替换从节点（Raft）

> 计数器+1 ， 每节点只能投一票，节点要票，超过半数（N/2 + 1）则当选。
>
> 没选出来，则计数器+1，再选一轮。