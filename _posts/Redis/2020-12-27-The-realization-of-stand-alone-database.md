---
title: 第二部分-单机数据库的实现
category: Redis
typora-root-url: ../../
---

 

## 服务器中数据库

默认创建16个数据库

用

SELECT 0 - 15 

选择数据库

不同数据库键和值相对独立

## 设置键的生存时间或过期时间

```
> setex k1 30 "lihenan"
OK
> ttl k1
(integer) 26
> ttl k1
(integer) 25
> get k1
"lihenan"
```

```
> expire key2 20
(integer) 1
> ttl key2
(integer) 15
> pttl key2
10945
```

通过expire 秒为单位 和 pexpire 毫秒为单位

expireat 和 pexpireat 设置过期时间戳

persist 移除过期时间

ttl 和 pttl 返回键的剩余生存时间，返回-2表示key不存在

## 过期键删除策略

## Redis过期键的删除策略

对于过期键一般有三种删除策略

- 定时删除：在设置键的过期时间的同时，创建一个定时器(timer)，让定时器在键的过期时间来临时，立即执行对键的删除操作；
- 惰性删除：放任键过期不管，但是每次从键空间中获取键时，都检查取得的键是否过期，如果过期的话，就删除该键；如果没有过期，那就返回该键；
- 定期删除：每隔一段时间，程序就对数据库进行一次检查，删除里面的过期键。至于删除多少过期键，以及要检查多少个数据库，则由算法决定。

下面我们来看看三种策略的优缺比较：

定时删除占用太多CPU时间，影响服务器的响应时间和吞吐量；

惰性删除浪费太多内存，有内存泄漏的危险。



定期删除策略是前两种策略的一种整合和折中：

- 定期删除策略每隔一段时间执行一次删除过期键操作，并通过**限制删除操作执行的时长和频率**来减少删除操作对CPU时间的影响；
- 通过定期删除过期键，定期删除策略有效地减少了因为过期键而带来的内存浪费；
- 定期删除策略的难点是确定删除操作执行的时长和频率。

Redis的过期键删除策略：Redis服务器实际使用的是 **惰性删除** 和 **定期删除** 两种策略。

删除过期键的DEL命令通过AOF的方式同步给从库



### 定期删除步骤 Redis 6.2

1. 运行25% CPU时间， 如果上次是时间到了导致结束，会运行最多1000微秒
2. 每次默认扫描16个库（然后判断是否超时，超时则退出），利用率少于1%的库不扫描
3. 扫当前库（每次最多默认检查20（可配置） * 20个键 ，最少20个键）
   1. 从字典0的一个位置开始遍历，判断是否要删除，累计删除计数器(expired)，和扫描计数器sampled
   2. 如果de->next == nil 增加桶计数器（最大20*20）
   3. 超时判断，超时则退出函数
   4. 扫描的键没有一个过期的，或者过期的键比例小于一个百分比（10%），则结束当前库的遍历

> https://github.com/redis/redis/blob/6.2/src/expire.c
>
> 
>
> idx &= db->expires->ht[table].sizemask;  // 没看懂
>
> 源码



### 客户端

客户端被关闭的情况：

1. 服务器设置了timeout ， 客户端空转超时被关闭（被阻塞和有订阅不算）
2. 发送的命令大小超过输入缓冲区的限制（1GB）
3. 回复的大小超过输出缓冲区的硬性限制
4. 回复的大小超过软性限制和配置的时间
5. 发送了不和协议格式的命令