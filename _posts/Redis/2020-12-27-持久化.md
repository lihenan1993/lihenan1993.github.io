---
title: 持久化
category: Redis
typora-root-url: ../../
---

 # RDB持久化

redis是内存型数据库，进程退出则数据消失，要还原状态就需要持久化

RDB是将数据库状态以二进制文件的形式存在文件中，以此还原数据库状态



## RDB文件的创建与载入

## RDB创建

生成RDB命令，SAVE 和 BGSAVE

SAVE： 阻塞Redis服务器进程，创建RDB完毕之前不能执行任何命令

BGSAVE：派生一个子进程（fork()方式），然后由子进程负责创建RDB文件，父进程继续处理命令请求



注意：

1. redis同时只能接受一个 sava, bgsave , bgrewriteaof命令 ，正在执行时候，其他命令被拒绝，防止出现竞争条件和性能问题。

2. 过期的键，不会保存在RDB文件中



### 自动保存

```
save 300 10
```

每300秒，至少有10次保存，则自动执行BGSAVE



## RDB载入

启动Redis自动载入，如果开启了AOF，直接载入AOF文件

载入时候redis会一直阻塞，直到载入完成



## RDB文件的压缩

RDB文件过大时，是可以压缩的，Redis默认开启压缩，当然也可以通过配置rdbcompression参数来禁用压缩。

**压缩和不压缩的优缺点：**

压缩：

```
优点：减少磁盘存储空间
缺点：消耗CPU资源
```

不压缩：

```
优点：不消耗CPU资源
缺点：占用磁盘空间多
```



# AOF持久化

AOF（Append Only File） 保存redis服务器所执行的写命令



## 持久化的实现

AOF持久化实现分为三个命令， 追加、写入、同步

1. 追加

   客户端的写命令以协议内容的格式追加到aof_buf缓冲区末尾



## AOF保存模式

Redis 目前支持三种 AOF 保存模式，它们分别是：

1. `AOF_FSYNC_NO` ：操作系统决定保存时机
2. `AOF_FSYNC_EVERYSEC` ：原则上每一秒钟同步一次
3. `AOF_FSYNC_ALWAYS` ：每执行一个命令同步一次

![digraph flush {](/assets/img/graphviz-1b226a6d0f09ed1b61a30d899372834634b96504.svg)

| 模式                 | WRITE 是否阻塞？ | SAVE 是否阻塞？ | 停机时丢失的数据量                                    |
| :------------------- | :--------------- | :-------------- | :---------------------------------------------------- |
| `AOF_FSYNC_NO`       | 阻塞             | 阻塞            | 操作系统最后一次对 AOF 文件触发 SAVE 操作之后的数据。 |
| `AOF_FSYNC_EVERYSEC` | 阻塞             | 不阻塞          | 一般情况下不超过 2 秒钟的数据。                       |
| `AOF_FSYNC_ALWAYS`   | 阻塞             | 阻塞            | 最多只丢失一个命令的数据。                            |



## AOF重写

不断记录命令，会导致AOF文件体积庞大，恢复慢。

AOF重写就是遍历数据库，创建写的写入命令，新的AOF文件覆盖旧的。

## AOF后台重写

fork的子进程写入的时候，主进程的改动记录到AOF缓冲区和AOF重写缓冲区

思想类似COW