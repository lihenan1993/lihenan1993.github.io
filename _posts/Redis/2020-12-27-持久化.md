---
title: 持久化
category: Redis
typora-root-url: ../../
---

 # RDB持久化

redis是内存型数据库，进程退出则数据消失，要还原状态就需要持久化

RDB是将数据库状态以二进制文件的形式存在文件中，以此还原数据库状态



## RDB文件的创建与载入

## RDB创建

生成RDB命令，SAVE 和 BGSAVE

SAVE： 阻塞Redis服务器进程，创建RDB完毕之前不能执行任何命令

BGSAVE：派生一个子进程（fork()方式），然后由子进程负责创建RDB文件，父进程继续处理命令请求



注意：

1. redis同时只能接受一个 sava, bgsave , bgrewriteaof命令 ，正在执行时候，其他命令被拒绝，防止出现竞争条件和性能问题。

2. 过期的键，不会保存在RDB文件中



### 自动保存

```
save 300 10
```

每300秒，至少有10次保存，则自动执行BGSAVE



## RDB载入

启动Redis自动载入，如果开启了AOF，直接载入AOF文件

载入时候redis会一直阻塞，直到载入完成



## RDB文件的压缩

RDB文件过大时，是可以压缩的，Redis默认开启压缩，当然也可以通过配置rdbcompression参数来禁用压缩。

**压缩和不压缩的优缺点：**

压缩：

```
优点：减少磁盘存储空间
缺点：消耗CPU资源
```

不压缩：

```
优点：不消耗CPU资源
缺点：占用磁盘空间多
```



## RDB优点和缺点

优点：全量数据快照，文件小，恢复快。

缺点：无法保证最近一次快照后的数据。



# AOF持久化

AOF（Append Only File） 保存redis服务器所执行的写命令

你可以通过修改配置文件来打开 AOF 功能：

```shell
appendonly yes
```



## 持久化的实现

AOF持久化实现分为三个命令， 追加、写入、同步

1. 追加

   客户端的写命令以协议内容的格式追加到aof_buf缓冲区末尾



## AOF保存模式

Redis 目前支持三种 AOF 保存模式，它们分别是：

1. `AOF_FSYNC_NO` ：操作系统决定保存时机
2. `AOF_FSYNC_EVERYSEC` ：原则上每一秒钟同步一次
3. `AOF_FSYNC_ALWAYS` ：每执行一个命令同步一次

![digraph flush {](/assets/img/graphviz-1b226a6d0f09ed1b61a30d899372834634b96504.svg)

| 模式                 | WRITE 是否阻塞？ | SAVE 是否阻塞？ | 停机时丢失的数据量                                    |
| :------------------- | :--------------- | :-------------- | :---------------------------------------------------- |
| `AOF_FSYNC_NO`       | 阻塞             | 阻塞            | 操作系统最后一次对 AOF 文件触发 SAVE 操作之后的数据。 |
| `AOF_FSYNC_EVERYSEC` | 阻塞             | 不阻塞          | 一般情况下不超过 2 秒钟的数据。                       |
| `AOF_FSYNC_ALWAYS`   | 阻塞             | 阻塞            | 最多只丢失一个命令的数据。                            |



## AOF重写

不断记录命令，会导致AOF文件体积庞大，恢复慢。

AOF重写就是遍历数据库，创建写的写入命令，新的AOF文件覆盖旧的。

## AOF后台重写

fork的子进程写入的时候，主进程的改动记录到AOF缓冲区和AOF重写缓冲区

思想类似COW



## AOF优点和缺点

优点：

1. 数据更完整，秒级数据丢失(取决于设置fsync策略)。、
2. 兼容性较高，由于是基于redis通讯协议而形成的命令追加方式，无论何种版本的redis都兼容。
3. aof文件是明文的，可阅读性较好。

缺点：

1. 数据文件体积较大，即使有重写机制，但是在相同的数据集情况下，AOF文件通常比RDB文件大。
2. 相对RDB方式，AOF速度慢于RDB，并且在数据量大时候，恢复速度AOF速度也是慢于RDB。
3. 由于频繁地将命令同步到文件中，AOF持久化对性能的影响相对RDB较大。



## 混合持久化

我们很少使用 RDB 来恢复内存状态，因为会丢失大量数据。

如果使用 AOF 日志重放，性能则相对 RDB 来说要慢很多



>混合持久化同样也是通过 BGREWRITEAOF  完成的，不同的是当开启混合持久化时，fork 出的子进程先将共享的内存副本**全量**的以RDB方式写入 AOF 文件，然后在将 aof_rewrite_buf 重写缓冲区的增量命令以 AOF 方式写入到文件，写入完成后通知主进程更新统计信息，并将新的含有 RDB 格式和 AOF 格式的 AOF 文件替换旧的的 AOF 文件。



Redis 4.0 开始支持 RDB 和 AOF 的混合持久化（默认关闭）。

如果把混合持久化打开，aof rewrite 的时候就直接把 rdb 的内容写到 aof 文件开头。

aof 文件内容会变成如下:

![img](/assets/img/20200810172132537.png)

混合持久化配置：

```shell
aof-use-rdb-preamble yes  # yes：开启，no：关闭
```



### 混合持久化优点和缺点

优点：重启效率高，还能减少数据的丢失。

缺点：兼容性差，一旦开启了混合持久化，在4.0之前版本都不识别该 AOF 文件，同时由于前部分是 RDB 格式，阅读性较差。