---
title: 以太坊 2.0
category: blockchain
typora-root-url: ../..
---

### 什么是以太坊2.0

以太坊 2.0，也被称为 Eth2 或 “宁静（Serenity）”，是以太坊区块链的未来升级。以太坊 2.0 将分多个 “阶段（Phase）” 发布，每个阶段都将以不同的方式改进以太坊的功能和性能。其整体技术部署共分为7个阶段，部署加过渡总体计划约5年。

以太坊2.0这场技术升级主要有三大创新：共识机制由POW转为POS、分片链(Shards Chains)和eWASM虚拟机。



### 以太坊2.0想解决的问题

以太坊1.0现在遇到的问题：

1. 系统吞吐量(TPS)低 ， 每秒只能处理7-15笔交易
   1. 每个全节点都需要验证整个以太坊网络上的交易并储存整个以太坊状态，这意味着每个全节点都在管理以太坊上所有的经济活动。
2. 网络拥堵时，手续费高
3. 可扩展性差。增加更多的节点并不能提高统吞吐量
4. 去中心化的程度会降低
   1. 一般用户无法支付运行以太坊节点的设备费用



**ETH 2.0 的一个目标是通过分片来分担处理和储存交易的工作，从而扩大交易吞吐量，提高可扩展性**

以太坊 2.0 不会清除 1.0 链上任何的数据历史、交易记录、或者资产所有权。



### 以太坊2.0的七个阶段

阶段0：没有分片的POS信标链 （2020年末，非硬性指标）

- 实现POS和POW共存

- 没有分片的**信标链**

- 存款合约（Deposite Contract）

  - 将ETH转化为ETH2.0代币，即信标链上的代币BETH（Beacon ETH）
  - 收集将来 ETH2.0 验证者的质押金
  - https://goerli.etherscan.io/address/0x07b39f4fde4a38bace212b546dac87c58dfe3fdc

- 验证者

  - ETH 2.0持币者可以成为以太坊网络中的验证者，质押其 ETH 从而在成功验证和组织新区块后获得奖励。

  - 锁在现在的以太坊区块链上等待销毁且不可取回，因此ETH→BETH的转化是单向不可逆的。此外，Phase0的信标链由于没有转账功能，故BETH不能在交易所交易，而智能合约功能也尚不存在，所以**信标链上的代币只能用于信标链的POS质押挖矿，并在很长一段时间都没有其他用途。**

    简而言之，即将上线的Phase0信标链就是这么一条“赤裸裸”没有功能的区块链，离真正的ETH2.0还差了好远。

阶段1：没有EVM的基本分片 （预计2021年或者2022年）

- 构建分片链和区块
- 将分片区块锚定到信标链（交链）

**以下阶段还没有任何规范的文档，属于设计阶段**

阶段2：EVM状态转换功能

阶段3：轻客户端状态协议

阶段4：跨分片交易

阶段5：与主链安全性紧密耦合

阶段6：超二次或指数分片

![img](/assets/img/22427204-2fa6dc4f11f05f54)

### 信标链和分片链

要理解信标链，我们首先了解一下分片技术(sharding computing)，它是以太坊2.0的核心功能。分片链与信标链是相互独立的，它是计划在Phase1才引入的功能。不过首先了解一下它有助于我们理解以太坊2.0的整体技术架构及其设计目的。以太坊1.0中系统每秒处理事务数大约为15，这样的吞吐量对于一个底层系统而言是远远不够的，建立在它之上的Dapp应用，通常会面临拥堵和体验不好的问题，而我们扩展系统时面临的主要困难是：每个节点都要验证和同步链上所有信息，这样的架构显然很容易达到瓶颈。

以太坊2.0中的分片技术就是为了解决这样的扩展问题。以太坊2.0的主要目标就是进行水平扩展，以信标链加上分片链的整体架构，让验证者仅仅处理和验证自己分片上的交易，或者只参与信标链主链上的共识过程。所以每个分片上的交易只会由全网的一个子集来处理，大大减轻了节点的负荷，加上采用权益证明的共识机制，验证者只需要消费级硬件就可以运行节点了。这样的整体架构下，全网的吞吐量将会有一个质的⻜跃。

采用分片技术最大的问题就是安全性问题，因为验证节点被分配到不同分片上且各自为政，因此攻击者攻破单个分片的难度就会大大降低。解决这个问题的核心，是在信标链中采用的随机方法，每个区块都由一组随机选择的验证者(Validator)所组成的委员会(Committee)来处理。只要一个验证者持有的权益少于全部验证者权益的1/3，那么系统被攻击的概率就为0，详细计算请查看文档。

- 信标链的主要内容就是一份验证者地址的注册表、每个验证者的状态、见证消息、以及链接到分片的信息。
- 指挥验证者的的工作

评论：

从生态上分析，分片技术的引入，由于提高了网络并行度，对上层的Dapp有极大的性能优化作用，在以太坊1.0中出现的拥堵和执行效率低下等问题将得到很大的缓解。甚至原本有一些由于效率原因而无法商用的功能，也将得到解锁。由于64个分片是独立执行的，意味着全网最多有64个分片可以并行执行，这类似于计算机由单线程变为了64线程。这无疑会让应用层的Dapp用户体验更加顺畅。我们大胆预测，以太坊2.0中的Dapp的数量和种类会是以太坊1.0上的5~10倍。分片技术将在phase1中引入，目前尚有一些技术细节未公布，不过技术本身是从数据库物理分片中延伸出来的成熟技术，也有成熟的实现方案。分片技术在生态上带来的革新将非常值得期待。

重要程度：★★★★★  实现难度：★★★☆☆

#### 启动前提

- 在Eth1主链上部署Eth2保证金合约。已达成（https://goerli.etherscan.io/address/0x07b39f4fde4a38bace212b546dac87c58dfe3fdc）

- 至少2个，理想情况下至少有3个ETH2客户端团队，推出可用于生产环境的软件版本。未达成

- 保证金合约发布后，至少有16,384名验证人（其中金额至少累计有524,288ETH）存入保证金。已达成（https://beaconcha.in/）



![640?wx_fmt=png](/assets/img/p)



![五分钟简述以太坊 2.0 信标链的作用与发展现状](/assets/img/1b33cbc8b0e81e9968f70db825e45d0e.jpg-article)



![640?wx_fmt=png](/assets/img/p-1607522952587)



### 时段(epoch)和时隙(slot)

每12秒信标链上就会产生一个区块，而64个分片链上分别同时产生64个分片区块。

信标链和各分片链的创世区块是在各自的0号时隙中产生的。

各分片链在信标链的时段(epoch)0完成之后才能开始。

分片链各有各的时段0，它们不必同步(时段0的0号时隙处产生各自的创世区块)。

一个时段是系统进行一次完整的随机分配和验证的基本单位

![640?wx_fmt=jpeg](/assets/img/3072053_image3-1607522945651.png)

评论：

时隙和时段同步了分片链和主链之间的节奏，同步的机制，不仅能够一定程度上更加。比起异步架构来讲，它也省去了大量分片之间和分片主链之间的通信成本，大家使用同一个时钟， 约时间的时候就不用换算了。对于应用开发者而言，他们无需过多涉入时隙和时段的技术细节，但是了解slot和epoch的原理，有助于开发者规划自己的应用，需要与主网交互的部分，确定等待时间和安全等级。

重要程度：★★★★☆  实现难度：★★★★☆

### 验证者(Validator)

以太坊2.0的一个核心转变，就是共识机制由POW转向了POS。以太坊2.0权益证明的网络，不再是依靠矿工，而是依靠验证者来维护。验证者是以太坊2.0网络的主动参与者。用户可以质押ETH来获得验证者资格，以此参与到网络建设中。所以说质押者是虚拟矿工，由节点主动质押激活。每个验证者最多的余额为32个ETH，也就是每个验证者的权益有一个上限，这样保证了公平，避免了单个验证者节点权益过大的情况，对安全性也有一定的提高。不过手里有很多ETH的用户可以通过质押，每32个ETH可获得一个完全的验证者资格，以此可以获得多个验证者资格。

- 32ETH兑换一个出块权利
- 可以抵押多次

对于大多数验证者在大多数时间内，都仅仅是对信标链或分片链产生的最新区块进行投票，这个过程叫做⻅证(attest)。它们的投票将决定信标链以及各个分片链上的最新区块。而在每个时隙中，系统都会随机选举出来一个验证者作为提议者，将由它来产生一个新的区块，并由其他验证者来⻅证(attesting), 对于一个提议者，它也可能同时是一个验证者。

在某个时隙中，被选为提议者的g并没有提议产生新的区块，因此这个时隙出的就是空块

![640?wx_fmt=jpeg](/assets/img/3072054_image3-1607522947694.png)

在一个时段中(epoch)，一名验证者只会被分配到一个时隙中，也只会被分配到一个分片链或信标链上。验证者会参与该分片的投票过程，以选举出最新的区块。如果它验证的是分片的区块， 那么它同样会在这个时隙内把最新的分片区块链接到信标链上。

- 验证者验证信标链或者分片链上区块正确性的过程，称为 见证
- 每个时隙（6m24s）中，验证者只能为一个链做见证
- 系统随机选出1个验证者出块，称为提议者
- 如果提议者出块的链是分片链，那么它同样会在这个时隙内把最新的分片区块链接到信标链上（交链p1阶段）
- 验证者节点要在网络中运行起来必须要依靠叫做验证者客户端的工具

### 投票委员会

**算法很复杂，主要是在POS共识下保证区块的安全性**

- 委员会就是一批随机选出的验证者，他们被随机分配到某时隙某分片链或信标链上，参与投票验证功能，每个委员会至少应该有128个验证者。

- 在一个时段(epoch)开始的时候，RANDAO会选出该时段内所有时隙的区块提议者，并且将验证者随机分配到各个委员会中去。

- 攻击者只有万亿分之一不到的几率，能控制一个委员会中 2/3 的验证者。

- 信标链这个名字，正是来源于其公开提供随机数的功能（即 “随机性信标”）。信标链会对一个叫做 “RANDAO” 的伪随机过程达成共识。

- 在每一个时段，伪随机过程 RANDAO 都会选出所有时隙的提议者，并且混洗验证者到不同的委员会去

- 混洗算法会增减委员会的数量，以保证每个委员会都至少有 128 名验证者

例子：

假设有 16384 名验证者。其中 512 名验证者被伪随机地分配到时隙 1，另外 512 个被分配到时隙 2，等等。时隙 1 的 512 个验证者被进一步切分成 4 个委员会。所有 512 个验证者都要在时隙 1 处发起 LMD GHOST 投票；其中一个委员会的 128 名验证者尝试交联到分片 33；另一个委员会的 128 名验证者尝试交联到分配 55；另外两个委员会则尝试交联到分片 22 和分片 11。

在时隙 2，这个过程会重复一遍。512 名验证者一样被划分成 4 个委员会。假定他们被分配到的分片为 41、20、17、15。所有的 512 个验证者都要在时隙 2 处为信标链的顶端投票；这几个委员会也会尝试为分片 41、20、17、15 提出交联。

这个过程也会在该时段剩下的时隙中一一重复。每个验证者都会有所在的时隙，在那个时隙 TA 就可以发声、提出见证消息、产生交联。等到时段结束之时，所有 16384 名验证者都已享受过发起投票和交联的机会。

但是，在上述过程中，验证者的投票都是基于时隙的，而不是基于时段的。有点像在给地方政府投票，而不是在搞全国大选。全体验证者未曾为同一个东西投票过。

### 合理化(justified)和最终确定(finalized)

略

### 信标链检查点(checkpoint)

略

### ⻅证消息(attestaion)

在介绍完了前面的各个机制之后，我们再回过头来深入理解一下验证者发送的⻅证消息。所谓的⻅证消息(attestation), 也就是验证者发起的投票，它包含该验证者投票的具体信息，并被验证者附加到最新的区块内。在每个时段，每个验证者都会发起一个⻅证消息，对其分配时隙内的区块进行投票，以及对时段的检查点区块进行投票，另外，所在委员会还要负责交链到随机分配的分片上。(参考前面交链和委员会那两节)

所以对于验证者而言，其最重要的职责就是提交⻅证消息，也就是提交投票。而attestation中的内容实际上包含3种投票，一个是对信标链顶端区块(最新区块)的投票，使用LMD Ghost算法进行分叉选择。第二个是使用Casper FFG算法对自己的epoch进行时段检查点区块投票，合理化检查点，以及最终确定检查点。最终确定的检查点之前的区块都不可篡改，而该检查点将成为新的LMD Ghost算法的起点。第三个就是交链，确定分片链的最新区块。在一个验证者的attestation中，就要包含这三种投票，他们指向的内容不同，对整个系统的贡献也不同。

评论：

一个⻅证消息，就是验证者投票的数据结构。它包含了三种投票，信标链顶端区块，检点区块，分片顶端区块。验证者在每个时段都要进行一次这样的投票。

### 新技术将带来的影响

以上我们讨论了以太坊2.0中的核心技术和原理。这些技术将从底层深刻的影响应用层的形态，Dapp的体验，同时也会催生出新的应用场景商业模式。以太坊2.0的技术架构主要解决了1.0所遇到的拥堵和效率问题，通过分片不仅提高了网络并行度，也提高了安全性，网络在吞吐量和可靠性方面将会有一个质的⻜跃。分片委员会，时段混洗机制，让每个验证者都能公平公正的参与网络验证，单个委员会被控的概率在万亿分之一的量级。在效率和安全方面的提升以及向POS机制的转变为上层Defi应用生态的发展提供了最重要的基础。

在POS共识机制方面，单个节点的权益限制，质押规则，惩罚机制，最大程度的保证了每个验证者公平公正随机的参与验证过程。同时，也提高了验证者接入网络的⻔槛。验证者客户端，slash检测，海量节点管理，成为了以太坊2.0 staking挖矿必须面对的技术问题，这些需求将形成一个新的商业机会，staking节点服务商。由于⻔槛较高，单个用户最好的staking策略就是交给专业的staking节点服务商进行拼单。

然而我们认为，staking的节点服务只是一个中间件的服务，他并不是以太坊2.0设计的重点。以太坊2.0的全部设计目的都是为了改善，优化其生态的体验和发展。每个技术上的改进都是在对标上层应用中遇到的问题。整个以太坊2.0的重点，并不在POS，不在staking挖矿，也不在经济模型，甚者不在技术本身，而在于要利用这些技术对上层的应用开发者生态造成深刻的影响，尽可能扩展主网的应用范围。基于2.0的产品技术形态将发生巨大的改变，用户体验也将得到巨大的提升，随之带来的是更广泛的应用落地，更丰富实用场景。

从经济激励上看，以太坊2.0的增发率为0.4%，而以太坊1.0的增发率为3.92%。以太坊2.0在设计上为上层应用留下了巨大的利润空间，它更加鼓励大家在参与在应用生态上的开发和建设，更多的利用以太坊2.0解决实际商业生产中的问题，而不只是挖矿。换句话说，如果一个Dapp足够好，只要能提供超过0.4%的年化收益，理性的用户就应该更倾向于参与这个的应用，而不是staking。在以太坊2.0中，staking是作为一个基本组件提供给上层的应用使用的，而不是主要获取代币的途径。它鼓励更多的用户参与应用生态，而不是单纯参与验证，不然又会重复现在无聊的挖矿游戏，而区块链技术的应用和落地却始终得不到发展。

以太坊2.0技术带来的影响，不是共识机制的转变，不是对ETH币价的巩固和提升，而是在工程领域和技术层面进行改进，“建好更平坦的赛道，吸引更多的赛⻋”。它的目的并不在区块链领域，而在于扩展区块技术及其适用的范围，提供更完善的基建，用区块链技术支撑应用去解决区块链世界之外的问题。而它要做是提供一个世界计算机。